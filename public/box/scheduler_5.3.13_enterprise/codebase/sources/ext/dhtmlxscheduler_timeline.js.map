{"version":3,"sources":["dhtmlxscheduler_timeline.js"],"names":["Scheduler","plugin","scheduler","_temp_matrix_scope","getChildrenIds","root","result","children","i","length","push","key","getSectionIndex","sectionId","timeline","sectionIndex","order","undefined","iterateSectionsTree","buildSectionsHash","units","y_unit_original","y_unit","prepareCellMatrix","events","fillXArray","matrix","xFrom","xTo","x","event","sectionsSearch","fillFolders","render","$tree","sectionProperty","y_property","sectionKey","scaleIndexStart","_get_date_index","start_date","scaleIndexEnd","end_date","valueOf","_trace_x","current","$parent","traversed","Error","label","parent","getScrollbarwidth","inner","document","createElement","style","width","height","outer","position","top","left","visibility","overflow","appendChild","body","w1","offsetWidth","w2","clientWidth","removeChild","timelineCellDateAttribute","cellDate","_helpers","formatDate","getScrollableContainer","view","dataWrapperDiv","querySelector","scrollable","$container","getLabelContainer","getColumnLabelContainer","initScroll","d","heights","render_stats","onLabelWrapperDivWheel","e","window","shiftKey","dy","deltaY","detail","wheelDelta","scrollTop","preventDefault","_is_ev_creating","header","_els","labelWrapperDiv","addEventListener","attachEvent","$eventsAttached","prevLabelAction","pageX","pageY","touch","touches","frameRequest","onscroll","element","scrollLeft","scrollHelper","getScrollValue","viewPort","_timeline_smart_render","getViewPort","colLabelDiv","smart_rendering","_x_scroll","second_scale","updateHeader","config","rtl","labelWrapperHeight","replace","scalesHeight","_section_height","_label_rows","getMode","modes","minMax","right","_options_changed","_y_scroll","updateLabels","updateGridCols","updateGridRows","asyncScroll","requestAnimationFrame","cancelAnimationFrame","name","getState","mode","updateEvents","callEvent","dataColHeight","_scales","rows","querySelectorAll","len","unit_key","getAttribute","rowIndex","newTop","newLeft","scrollWidth","_summ","dx","custom_scroll_width","_timeline_save_scroll_pos","_is_new_view","prevAction","drag_id","absoluteDx","Math","abs","absoluteDy","totalDistance","sqrt","horizontalComponent","verticalComponent","setScrollValue","scroll_position","scrollTo","_timeline_set_scroll_pos","closest","selector","matches","msMatchesSelector","webkitMatchesSelector","el","documentElement","contains","call","parentElement","parentNode","nodeType","console","error","getRelativeCoordinates","_mode","pos","offset","container","y","offsetLeft","offsetTop","offsetParent","autoscrollInterval","interval","clearInterval","_schedulerOuter","eventPos","setInterval","tick","scrollInterval","startPos","viewport","box","availWidth","availHeight","offsetHeight","posX","posY","settings","autoscroll","_merge","range_x","range_y","speed_x","speed_y","need_scroll","started","scroll","boxSize","startCoord","scrollRange","scrollHelperFactory","createTestElement","cssText","content","detectScrollMode","demoElement","nMaxMin","maxMin","normalizeValue","value","direction","getComputedStyle","maxScroll","normalized","currentMode","a","b","c","createTimelineView","obj","selectBySection","selectSubsections","evs","getPreparedEvents","section","subsections","sectionEvents","concat","j","selectByDate","date","columnEvents","nestedEvents","cellIndex","$matrix","calculateUnits","from","to","scaleStartDate","Date","currentDate","x_step","x_unit","add","_skin_init","column_width","_section_autowidth","_h_cols","section_autoheight","y_step","x_start","x_size","y_start","y_size","event_dy","xy","bar_height","event_min_dy","resize_events","fit_events","show_unassigned","round_position","_logic","render_name","res","checkEvent","_original_x_start","first_hour","last_hour","_start_correction","_end_correction","dhtmlxEventable","old","render_data","this","apply","arguments","clear_event","render_timeline_event","_renderMatrix","templates","ar","arr","folder_events_available","section_id","section_label","section_options","text","datea","dateb","getDay","date_part","getHours","getMinutes","day_date","week_date","date_to_str","x_date","hour_date","step","shift","unit","scroll_step","resulting_date","x_length","size","converted_step","total_steps","steps_offset","round","func","day_start","start_offset","getTimezoneOffset","new_offset","setTime","getTime","_smartRenderingEnabled","_sch_height","scrollableDataContainer","bind","scrollPosition","scrollDate","posFromSection","posLeft","posFromDate","getScrollPosition","_timeline_getX","dateFromPos","_timeline_drag_date","sectionFromPos","_resolve_timeline_section","resolvePosition","selectEvents","selectNested","setRange","setCurrentView","enable","_set_timeline_dates","temp_date","ev","_drag_event","_drag_id","getEvent","converted","scale_width","force_redraw","custom","_drag_mode","drag_event","_ignores","_ignores_detected","_move_delta","preserve_length","_get_real_event_length","_event_length","current_back_shift","_get_fictional_event_length","timeline_swap_resize","_drag_from_start","resize_from_start","time_step","_timeline_get_rounded_date","_resize_from_start","_update_timeline_section","_correct_shift","_min_date","_drag_start","pos_changed","_is_pos_changed","_drag_pos","_dhx_changed","has_moved","_prepare_timeline_events","_timeline_trace_events","tevs","get_visible_events","tev","tev_section","index","hasOwnProperty","clone","_lame_copy","_populate_timeline_rendered","_rendered","divs","_get_timeline_event_height","event_height","max","floor","_count","_get_timeline_event_y","sorder","cascade_event_display","cascade_event_margin","attach","_sorder","x_end","hb","_inner","section_height","_events_height","cs","event_class","select_id","id","_no_drag_move","bg_color","color","textColor","event_bar_text","html","_waiAria","eventBarAttrString","_text_style","drag_resize","readonly","dhx_event_resize","hb_local","resize_start","resize_end","_no_resize_start","_no_resize_end","innerHTML","parentSection","firstChild","escapeForAttribute","rawValue","String","escapeForSelector","isEndPoint","_step","column_offset","_max_date","delta","_min_date_timeline","_cols","column_date","_border_box_events","isEndDate","rounded_date","_timeline_skip_ignored","visible","splice","_timeline_calculate_event_positions","sort","stack","evs_length","maxOrder","maxOrderEvent","ev_start_date","sorderSet","p","t_ev","h","_is_sorder","t","_max_sorder","w","max_count","m","_register_copy","_timeline_get_events_html","v","_timeline_update_events_html","getView","ids","getEventKey","eventId","forEach","_timeline_get_block_stats","stats","style_data_wrapper","style_label_wrapper","html_scroll_width","_timeline_get_cur_row_stats","heightWithoutScroll","scroll_width","td_className","td_content","tr_className","style_height","style_width","summ_width","table_className","_timeline_get_fit_events_stats","rendered_height","style_line_height","_timeline_get_html_for_cell_data_row","top_pos","rowId","templateParams","css","template","_timeline_get_html_for_cell_ignores","_timeline_get_html_for_cell","x_ind","y_ind","cellLeftPos","cellSection","cellWidth","cellDateString","_timeline_get_html_for_bar_matrix_line","_timeline_get_html_for_bar_data_row","_timeline_get_html_for_bar_ignores","_timeline_get_html_for_bar","cell_template","lineHeight","_timeline_render_scale_header","show","headerAreaClass","headerHeight","scale_height","className","nav_height","join","locale","labels","_timeline_y_scale","block_stats","scrollableData","labelWrapper","dataWrapper","_load_mode","_load","clearPreparedEventsCache","cachePreparedEvents","summ","realcount","_colsS","skipRenderCells","cellTopPos","_rendered_labels_cache","_rendered_events_cache","smartRender","rowStats","totalRowsHeight","row","labelRow","div","isInYViewPort","bottom","colIndex","isInXViewPort","printableEvents","getVisibleEventsForRow","_matrix","_timeline_finalize_section_add","scale","old_mode","old_date","_timeline_x_dates","preserve","start","end","_process_ignores","display_count","total_count","total","displayed","_timeline_x_scale","current_sh","original_sh","_header_resized","preserve_scale_length","dates","_x","summ_fixed","k","control_dates","second_cols","second_left","t_index","l","_timeline_is_new_interval","lastChild","tdate","scs","head","set_xy","_render_x_header","setAttribute","clnLastChild","cloneNode","trace","onclick","_timeline_locate_hcell","ondblclick","control_date","getDate","getMonth","getFullYear","week_start","_timeline_reset_scale_height","_timeline_set_full_view","set_sizes","_init_matrix_tooltip","temp","curHeader","getVisibleHeader","dhx_cal_header","dateElement","_getNavDateElement","_mark_now","_timeline_hideToolTip","_tooltip","display","_timeline_showToolTip","mark","_click","dhx_cal_data","_timed","event_date","src","_matrix_tooltip_handler","_locate_cell_timeline","target","srcElement","$domHelpers","getOffset","_detachDomEvent","_date","_table_view","refresh","_timeline_html_index","childNodes","nodeIndex","resIndex","trg","tagName","_getClassName","split","getActionData","ign","xNonIgnoredInd","xind","firstCellXind","_isRender","firstCell","fc_pos_x","isScale","scaleTarget","old_click","dhx_marked_timespan","ret","dblclick_dhx_matrix_cell","old_dblclick_marked_timespan","dblclick_dhx_marked_timespan","dblclick_dhx_matrix_scell","type","dblclick_create","event_options","addEventNow","event_id","native_event_object","isOneDayEvent","flag","ev_old","_is_column_visible","start_ind","old_render_marked_timespan","_render_marked_timespan","options","area","unit_id","min_date","max_date","display_marked_timespans","view_opts","blocks","areas","sections","days","specific_date","_get_dates_by_index","zones","css_classes","_get_css_classes_by_config","zone_start","zone_end","block","_get_block_by_config","start_pos","end_pos","insertBefore","old_append_mark_now","_append_mark_now","day_index","now","n_date","_currentDate","_get_zone_minutes","oldTimespans","_mark_timespans","r","_on_scale_add_marker","on_scale_marker_add","timespans","_marked_timespans","global_data","t_date","day_value","r_configs","day_types","_get_configs_to_render","z_config","unit_types","_get_types_to_render","day","yind","_orig_section","fields","action","line_height","_get_dnd_order","trace_x","searchFrom","searchTo","dateValue","middle","pos_x","ratio","edge","drag_mode","timestamp_diff","setTimeout","indexOf","evId","detachEvent","_prepared_events_cache","_rendered_header_cache","_rows_to_delete","_rows_to_add","_cols_to_delete","_cols_to_add","resizeHeight","scrollBlock","coords","getBoundingClientRect","scrollableContainer","copy","item","viewPortLeft","viewPortRight","viewPortTop","viewPortBottom","col","outerHTML","headers","cells","visibleItems","renderers","slice","itemsToDel","_deleteHeaderCells","_addHeaderCells","items","insertAdjacentHTML","getVisibleLabels","curLabelCol","_deleteLabelCells","_addLabelCells","_prepared_events_coordinate_cache","$coordinates","visibleEvents","grid","eventsToAdd","visibleRowEvents","lenRend","line","_deleteEvents","_addEvents","classList","events_html","evsInViewport","rowEvents","evLen","xStart","xEnd","coordinateCacheKey","getVisibleRowCellsHTML","visibleColumns","ind","getVisibleTimelineRowsHTML","cachedRow","_deleteGridRows","_addGridRows","visibleHeaderColumns","renderedTimelineColumnsHash","visibleHeaderColumnsHash","anyRow","columns","shouldDelete","shouldRender","_deleteGridCols","_addGridCols","cell","getVisibleGridCell"],"mappings":"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 scaleStartDate = scheduler.date[this.name + '_start'](new Date(from));
		// count the required value of timeline.x_size to display the required range.
		var units = calculateUnits(from, to, this);

		// and modify timeline settings  with the calculated number of steps
		this.x_size = units;

		// when settings are updated - tell scheduler to display a requested start date,
		// the time scale should contain range from startDate to endDate
		scheduler.setCurrentView(scaleStartDate, this.name);
	}, obj);

	scheduler.callEvent("onOptionsLoad",[obj]);

	//init custom wrappers
	scheduler[obj.name+"_view"]=function(enable){
		if(enable){
			scheduler._set_timeline_dates(obj);
			//_renderMatrix will be called by render_data immediately after
		}else{
			scheduler._renderMatrix.apply(obj, arguments);
		}
	};

	//enable drag for non-cell modes
	var temp_date = new Date();
	var step_diff = (scheduler.date.add(temp_date, obj.x_step, obj.x_unit).valueOf() - temp_date.valueOf()); // "minute" + step in ms
	scheduler["mouse_"+obj.name]=function(pos){ //mouse_coord handler
		//get event object
		var ev = this._drag_event;
		if (this._drag_id){
			ev = this.getEvent(this._drag_id);
		}
		if (obj.scrollable  && !pos.converted) {
			pos.converted = 1;
			pos.x += -obj.dx + obj._x_scroll;
			if (scheduler.config.rtl) {
				var labelWrapperHeight = +scheduler.$container.querySelector(".dhx_timeline_label_wrapper").style.height.replace("px", "");
				var scalesHeight = obj._section_height[obj.y_unit.length] + obj._label_rows[obj._label_rows.length - 1].top;
				pos.x += scheduler.xy.scale_width;
				if (obj.scrollHelper.getMode() == obj.scrollHelper.modes.minMax && (scalesHeight > labelWrapperHeight || obj.render == "tree")) pos.x += getScrollbarwidth();
			}
			pos.y += obj._y_scroll;
		} else if (!scheduler.config.rtl){
			pos.x -= obj.dx;
		} else {
			pos.x -= (obj.dx-scheduler.xy.scale_width);
		}
		var end_date = scheduler._timeline_drag_date(obj, pos.x);

		pos.x =  0;
		pos.force_redraw = true;
		pos.custom = true;

		// as we can simply be calling _locate_cell_timeline
		if (this._drag_mode == "move" && this._drag_id && this._drag_event) {
			var ev = this.getEvent(this._drag_id);
			var drag_event = this._drag_event;

			pos._ignores = (this._ignores_detected || obj._start_correction || obj._end_correction);
			if (drag_event._move_delta === undefined) {
				drag_event._move_delta = (ev.start_date-end_date)/60000;
				if (this.config.preserve_length && pos._ignores){
					drag_event._move_delta = this._get_real_event_length(ev.start_date,end_date, obj);
					drag_event._event_length = this._get_real_event_length(ev.start_date,ev.end_date, obj);
				}
			}


			//preserve visible size of event
			if (this.config.preserve_length && pos._ignores){
				var ev_length = drag_event._event_length;//this._get_real_event_length(ev.start_date, ev.end_date, obj);
				var current_back_shift = this._get_fictional_event_length(end_date, drag_event._move_delta, obj, true);
				end_date = new Date(end_date - current_back_shift);
			} else {
				// converting basically to start_date
				end_date = scheduler.date.add(end_date, drag_event._move_delta, "minute");
			}
		}

		if (this._drag_mode == "resize" && ev){
			if(this.config.timeline_swap_resize && this._drag_id){
				if(this._drag_from_start && +end_date> +ev.end_date){
					this._drag_from_start = false;
				}else if(!this._drag_from_start && +end_date < +ev.start_date){
					this._drag_from_start = true;
				}
			}
			pos.resize_from_start = this._drag_from_start;
			if(!this.config.timeline_swap_resize && this._drag_id){
				if(this._drag_from_start && +end_date >= +scheduler.date.add(ev.end_date, -scheduler.config.time_step, "minute")){
					end_date = scheduler.date.add(ev.end_date, -scheduler.config.time_step, "minute");
				}
			}
		}

		if (obj.round_position) {
			switch(this._drag_mode) {
				case "move":
					if (!this.config.preserve_length){
						end_date = scheduler._timeline_get_rounded_date.call(obj, end_date, false);
						// to preserve original start and end dates
						if(obj.x_unit == "day")//only make sense for whole-day cells
							pos.custom = false;
					}
					break;
				case "resize":
					if(this._drag_event){
						// will save and use resize position only once
						if (this._drag_event._resize_from_start === null || this._drag_event._resize_from_start === undefined) {
							this._drag_event._resize_from_start = pos.resize_from_start;
						}
						pos.resize_from_start = this._drag_event._resize_from_start;
						end_date = scheduler._timeline_get_rounded_date.call(obj, end_date, !this._drag_event._resize_from_start);
					}
					break;
			}
		}

		this._resolve_timeline_section(obj, pos);
		if(pos.section){
			// update draggable event with current section
			this._update_timeline_section({pos:pos, event:this.getEvent(this._drag_id), view:obj});
		}
		pos.y = Math.round((this._correct_shift(end_date,1)-this._min_date)/(1000*60*this.config.time_step));
		pos.shift = this.config.time_step; //step_diff;

		if (obj.round_position && this._drag_mode == "new-size") {
			if(end_date <= this._drag_start){
				pos.shift = scheduler.date.add(this._drag_start, obj.x_step, obj.x_unit) - this._drag_start;
			}
		}

		var pos_changed = this._is_pos_changed(this._drag_pos, pos);
		if(this._drag_pos && pos_changed){
			this._drag_event._dhx_changed = true;
		}
		if(!pos_changed && !this._drag_pos.has_moved)
			pos.force_redraw = false;

		return pos;
	};
};

scheduler._prepare_timeline_events = function(timeline){
	var evs = [];
	if (timeline.render == "cell"){
		evs = scheduler._timeline_trace_events.call(timeline);
	} else {

		var tevs = scheduler.get_visible_events();
		var order = timeline.order;

		for (var j = 0; j < tevs.length; j++) {
			var tev = tevs[j];
			var tev_section = tev[timeline.y_property];
			var index = timeline.order[ tev_section ];
			var sectionObject = timeline.y_unit[index];

			if (timeline.show_unassigned && !tev_section) {
				for (var key in order) {
					if (order.hasOwnProperty(key)) {
						index = order[key];
						if (!evs[index]) evs[index] = [];
						var clone = scheduler._lame_copy({}, tev);
						clone[timeline.y_property] = key;
						evs[index].push(clone);
						break;
					}
				}
			} else {
				// required as we could have index of not displayed section or "undefined"
				if (!evs[index]) evs[index] = [];
				evs[index].push(tev);
			}
		}

		//if(timeline.cell_template){
		evs.$matrix = scheduler._timeline_trace_events.call(timeline);
		//}


	}
	return evs;
};

scheduler._populate_timeline_rendered = function(container){
	scheduler._rendered = [];
	var divs = container.querySelectorAll("div[event_id]");
	for (var i=0; i < divs.length; i++){
		scheduler._rendered.push(divs[i]);
	}
};

scheduler._get_timeline_event_height = function(ev, config){
	var section = ev[config.y_property]; // section id
	var event_height = config.event_dy;
	if (config.event_dy == "full") {
		if (config.section_autoheight) {
			event_height = config._section_height[section] - 6;
		} else {
			event_height = config.dy - 3;
		}
	}

	if (config.resize_events) {
		event_height = Math.max(Math.floor(event_height / (ev._count||1)), config.event_min_dy);
	}
	return event_height;
};
scheduler._get_timeline_event_y = function(order, event_height){
	var sorder = order || 0;
	var y = 2+sorder*event_height+(sorder?(sorder*2):0); // original top + number_of_events * event_dy + default event top/bottom borders
	if (scheduler.config.cascade_event_display) {
		y =2+sorder*scheduler.config.cascade_event_margin+(sorder?(sorder*2):0);
	}
	return y;
};

scheduler.render_timeline_event = function(ev, attach){
	var section = ev[this.y_property]; // section id
	if (!section)
		return ""; // as we may await html

	var sorder = ev._sorder;

	var x_start = scheduler._timeline_getX(ev, false, this);
	var x_end = scheduler._timeline_getX(ev, true, this);

	var event_height = scheduler._get_timeline_event_height(ev, this);

	var hb = event_height - 2;// takes into account css sizes (border/padding)
	if (!ev._inner && this.event_dy == "full") {
		hb=(hb+2)*(ev._count-sorder)-2;
	}

	hb += 3;// correction for border-box sizing

	var y = scheduler._get_timeline_event_y(ev._sorder, event_height);
//	if(isNaN(y) || isNaN(hb)){
//		debugger;
//	}
	var section_height = event_height+y+2;
	if(!this._events_height[section] || (this._events_height[section] < section_height)){
		this._events_height[section] = section_height;
	}

	var cs = scheduler.templates.event_class(ev.start_date,ev.end_date,ev);
	cs = "dhx_cal_event_line "+(cs||"");

	if(scheduler.getState().select_id == ev.id){
		cs += " dhx_cal_event_selected";
	}

	if(ev._no_drag_move){
		cs += " no_drag_move";
	}

	var bg_color = (ev.color?("background:"+ev.color+";"):"");
	var color = (ev.textColor?("color:"+ev.textColor+";"):"");
	var text = scheduler.templates.event_bar_text(ev.start_date,ev.end_date,ev);


	var html="<div "+scheduler._waiAria.eventBarAttrString(ev)+" event_id='"+ev.id+"' class='"+cs+"' style='"+bg_color+color+"position:absolute; top:"+y+"px; height: "+hb+"px; "+(scheduler.config.rtl ? "right:":"left:")+x_start+"px; width:"+Math.max(0,x_end-x_start)+"px;"+(ev._text_style||"")+"'>";
	if (scheduler.config.drag_resize && !scheduler.config.readonly) {
		var dhx_event_resize = 'dhx_event_resize';

		var hb_local = hb + 1; // corrected hb after changing table to divs, position of resize markers were rendered wrong
		var resize_start = "<div class='"+dhx_event_resize+" "+dhx_event_resize+"_start' style='height: "+hb_local+"px;'></div>";
		var resize_end = "<div class='"+dhx_event_resize+" "+dhx_event_resize+"_end' style='height: "+hb_local+"px;'></div>";
		html += (!ev._no_resize_start ? resize_start : "") + (!ev._no_resize_end ? resize_end : "");
	}
	html += (text+'</div>');

	if (!attach)
		return html;
	else {
		var d = document.createElement("div");
		d.innerHTML = html;

		var parentSection = this._scales[section];
		if (parentSection){
			scheduler._rendered.push(d.firstChild);
			parentSection.appendChild(d.firstChild);
		}
	}
};

function getChildrenIds(root, result){
	result = result || [];
	if(root.children){
		for(var i = 0; i < root.children.length; i++){
			result.push(root.children[i].key);
			getChildrenIds(root.children[i], result);
		}
	}
	return result;
}

function getSectionIndex(sectionId, timeline){
	var sectionIndex = timeline.order[sectionId];
	if(sectionIndex === undefined){
		// row inside a collapsed branch
		sectionIndex = "$_" + sectionId;
	}
	return sectionIndex;
}

function iterateSectionsTree(root, result){
	result[root.key] = root;
	if(root.children){
		for(var i = 0; i < root.children.length; i++){
			iterateSectionsTree(root.children[i], result);
		}
	}
}

function buildSectionsHash(timeline){
	var result = {};
	var units = timeline.y_unit_original || timeline.y_unit;
	for(var i = 0; i < units.length; i++){
		iterateSectionsTree(units[i], result);

	}
	return result;

}

function prepareCellMatrix(events, timeline){
	var matrix =[];
	for (var i=0; i < timeline.y_unit.length; i++){
		matrix[i]=[];
	}

	//next code defines row for undefined key
	//most possible it is an artifact of incorrect configuration
	var sectionIndex;
	if (!matrix[sectionIndex]){
		matrix[sectionIndex]=[];
	}

	var sectionsSearch = buildSectionsHash(timeline);

	var fillFolders = timeline.render == "tree";
	if(fillFolders){
		matrix.$tree = {};
	}

	function fillXArray(matrix, sectionIndex, xFrom, xTo){
		if(!matrix[sectionIndex]){
			matrix[sectionIndex]=[];
		}
		for(var x = xFrom; x <= xTo; x++){
			if (!matrix[sectionIndex][x]) matrix[sectionIndex][x]=[];
			matrix[sectionIndex][x].push(event);
		}
	}

	var sectionProperty = timeline.y_property;
	for (var i=0; i < events.length; i++) {
		var event = events[i];
		var sectionKey = event[sectionProperty];
		sectionIndex = getSectionIndex(sectionKey, timeline);
		var scaleIndexStart = scheduler._get_date_index(timeline, event.start_date);
		var scaleIndexEnd = scheduler._get_date_index(timeline, event.end_date);
		if(event.end_date.valueOf() == timeline._trace_x[scaleIndexEnd].valueOf()){
			scaleIndexEnd -= 1;
		}

		if(!matrix[sectionIndex]){
			matrix[sectionIndex]=[];
		}

		fillXArray(matrix, sectionIndex, scaleIndexStart, scaleIndexEnd);

		var current = sectionsSearch[sectionKey];
		if(fillFolders && current && current.$parent){
			var traversed = {};
			
			while(current.$parent){
				if(traversed[current.key]) {
					throw new Error("Invalid sections tree. Section `{key:'" + current.key + "', label:'"+current.label+"'}` " +
					"has the same key as one of its parents. Make sure all sections have unique keys");
				}
				traversed[current.key] = true;

				var parent = sectionsSearch[current.$parent];
				fillXArray(matrix.$tree, parent.key, scaleIndexStart, scaleIndexEnd);
				current = parent;
			}
		}
	}

	return matrix;
}

var escapeForAttribute = function(rawValue){
	var value = String(rawValue);
	return value.replace(/'/g, "&apos;").replace(/"/g, '&quot;');
};
var escapeForSelector = function(rawValue){
	var value = String(rawValue);
	return value.replace(/'/g, "\\'").replace(/"/g, '\\"');
};

scheduler._timeline_trace_events = function trace_events(){
	//minimize event set
	var evs = scheduler.get_visible_events();
	var matrix = prepareCellMatrix(evs, this);
	//if(this.render == "tree"){
	//	fillFolderEvents(matrix, this);
	//}
	return matrix;
};

// function used to get X (both start and end) coordinates for timeline bar view
scheduler._timeline_getX = function _getX(ev, isEndPoint, config) {
	var x = 0;
	var step = config._step;
	var round_position = config.round_position;

	var column_offset = 0;
	var date = (isEndPoint) ? ev.end_date : ev.start_date;

	if(date.valueOf()>scheduler._max_date.valueOf())
		date = scheduler._max_date;
	var delta = date - scheduler._min_date_timeline;

	if (delta > 0){
		var index = scheduler._get_date_index(config, date);
		if (scheduler._ignores[index])
			round_position=true;

		for (var i = 0; i < index; i++) {
			x += scheduler._cols[i];
		}

		var column_date = scheduler._timeline_get_rounded_date.apply(config, [date, false]);
		//var column_date = scheduler.date.add(scheduler._min_date_timeline, scheduler.matrix[scheduler._mode].x_step*index, scheduler.matrix[scheduler._mode].x_unit);
		if (!round_position) {
			delta = date - column_date;
			if (config.first_hour || config.last_hour){
				delta = delta - config._start_correction;
				if (delta < 0) delta = 0;
				column_offset = Math.round(delta/step);
				if (column_offset > scheduler._cols[index])
					column_offset = scheduler._cols[index];
			} else {
				column_offset = Math.round(delta/step);
			}
		} else {
			if (+date > +column_date && isEndPoint) {
				column_offset = scheduler._cols[index];
			}
		}
	}

	var borderBox = scheduler._border_box_events();

	if (isEndPoint) {
		// special handling for "round" dates which match columns and usual ones
		if (delta !== 0 && !round_position) {
			x += column_offset;
		} else {
			x += column_offset - 2;
		}
	} else {
		x += column_offset+1;
	}
	return x;
};

scheduler._timeline_get_rounded_date = function get_rounded_date(date, isEndDate) {
	var index = scheduler._get_date_index(this, date);
	var rounded_date = this._trace_x[index];
	if (isEndDate && (+date != +this._trace_x[index])) {
		rounded_date = (this._trace_x[index+1]) ? this._trace_x[index+1] : scheduler.date.add(this._trace_x[index], this.x_step, this.x_unit);
	}
	return new Date(rounded_date);
};

scheduler._timeline_skip_ignored = function skip_ignored(evs){

	if(scheduler._ignores_detected){
		var from,
			to,
			visible,
			ev;

		for(var i = 0; i < evs.length; i++){
			ev = evs[i];
			visible = false;
			from = scheduler._get_date_index(this, ev.start_date);
			to = scheduler._get_date_index(this, ev.end_date);

			while(from < to){
				if(!scheduler._ignores[from]){
					visible = true;
					break;
				}
				from++;
			}
			if(!visible && from == to && !scheduler._ignores[to]){
				if(+ev.end_date > +this._trace_x[to]){
					visible = true;
				}
			}
			if(!visible){
				evs.splice(i, 1);
				i--;
			}
		}
	}
};

// calculates timeline event sorder and update timeline section heights
scheduler._timeline_calculate_event_positions = function(evs){
	if (evs && this.render != "cell"){

		scheduler._timeline_skip_ignored.call(this, evs);

		evs.sort(this.sort || function(a,b){
			if(a.start_date.valueOf()==b.start_date.valueOf())
				return a.id>b.id?1:-1;
			return a.start_date>b.start_date?1:-1;
		});
		var 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._mode];
	if (obj){
		var pos = scheduler._locate_cell_timeline(e);
		if (pos){
			if (pos.scale)
				scheduler.callEvent("onYScaleDblClick",[pos.y, obj.y_unit[pos.y], e||event]);
			else
				scheduler.callEvent("onCellDblClick",[pos.x, pos.y, obj._trace_x[pos.x], (((obj._matrix[pos.y]||{})[pos.x])||[]), e||event]);
		}
	}
};

var old_dblclick_marked_timespan = scheduler.dblclick_dhx_marked_timespan || function(){};
scheduler.dblclick_dhx_marked_timespan = function(e){
	var obj = scheduler.matrix[scheduler._mode];
	if (obj)
		return scheduler.dblclick_dhx_matrix_cell(e);
	else
		return old_dblclick_marked_timespan.apply(this,arguments);
};

scheduler.dblclick_dhx_matrix_scell = function(e){
	return scheduler.dblclick_dhx_matrix_cell(e);
};

scheduler._isRender = function(mode){
	return (scheduler.matrix[scheduler._mode] && scheduler.matrix[scheduler._mode].render == mode);
};

scheduler.attachEvent("onCellDblClick", function (x, y, a, b, event){
	if (this.config.readonly|| (event.type == "dblclick" && !this.config.dblclick_create)) return;

	var obj = scheduler.matrix[scheduler._mode];
	var event_options = {};
	event_options.start_date = obj._trace_x[x];
	event_options.end_date = (obj._trace_x[x+1]) ? obj._trace_x[x+1] : scheduler.date.add(obj._trace_x[x], obj.x_step, obj.x_unit);

	if (obj._start_correction)
		event_options.start_date = new Date(event_options.start_date*1 + obj._start_correction);
	if (obj._end_correction)
		event_options.end_date = new Date(event_options.end_date - obj._end_correction);

	event_options[obj.y_property] = obj.y_unit[y].key;
	scheduler.addEventNow(event_options, null, event);
});

scheduler.attachEvent("onBeforeDrag", function (event_id, mode, native_event_object){
	return !scheduler._isRender("cell");
});
scheduler.attachEvent("onEventChanged", function(id, ev) {
	ev._timed = this.isOneDayEvent(ev);
});
scheduler.attachEvent("onBeforeEventChanged", function (ev, e, flag, ev_old) {
	if(ev){
		ev._move_delta = undefined;
	}
	if(ev_old){
		ev_old._move_delta = undefined;
	}
	return true;
});

scheduler._is_column_visible = function(date){
	var mode = scheduler.matrix[scheduler._mode];
	var start_ind = scheduler._get_date_index(mode, date);
	return !scheduler._ignores[start_ind];
};
var old_render_marked_timespan = scheduler._render_marked_timespan;
scheduler._render_marked_timespan = function(options, area, unit_id, min_date, max_date) {
	if (!scheduler.config.display_marked_timespans)
		return [];

	if (scheduler.matrix && scheduler.matrix[scheduler._mode]) {
		if (scheduler._isRender('cell'))
			return;

		var view_opts = scheduler._lame_copy({}, scheduler.matrix[scheduler._mode]);
		//timespans must always use actual position, not rounded
		view_opts.round_position = false;
		var blocks = [];

		var units = [];
		var areas = [];
		var section = options.sections ? (options.sections.units || options.sections.timeline) : null;
		if (!unit_id) {  // should draw for every unit...
			var order = view_opts.order;
			if (section) { // ...or for only section if mentioned in configuration of timespan
				if (order.hasOwnProperty(section)) {
					units.push(section);
					areas.push(view_opts._scales[section]);
				}
			}else{
				if(view_opts._scales) {
					for (var key in order) {
						if (order.hasOwnProperty(key) && view_opts._scales[key]) {
							units.push(key);
							areas.push(view_opts._scales[key]);
						}
					}
				}
			}
		} else {
			areas = [area];
			units = [unit_id];
		}

		var min_date = min_date ? new Date(min_date) : scheduler._min_date;
		var max_date = max_date ? new Date(max_date) : scheduler._max_date;

		if(min_date.valueOf() < scheduler._min_date.valueOf())
			min_date = new Date(scheduler._min_date);
		if(max_date.valueOf() > scheduler._max_date.valueOf())
			max_date = new Date(scheduler._max_date);

		if(!view_opts._trace_x) return;

		for(var i = 0; i < view_opts._trace_x.length; i++){
			if(scheduler._is_column_visible(view_opts._trace_x[i]))
				break;
		}
		if(i == view_opts._trace_x.length)
			return;

		var dates = [];

		if (options.days > 6) {
			var specific_date = new Date(options.days);
			if (scheduler.date.date_part(new Date(min_date)) <= +specific_date && +max_date >= +specific_date)
				dates.push(specific_date);
		} else {
			dates.push.apply(dates, scheduler._get_dates_by_index(options.days));
		}

		var zones = options.zones;
		var css_classes = scheduler._get_css_classes_by_config(options);

		for (var j=0; j<units.length; j++) {
			area = areas[j];
			unit_id = units[j];

			for (var i=0; i<dates.length; i++) {
				var date = dates[i];
				for (var k=0; k<zones.length; k += 2) {
					var zone_start = zones[k];
					var zone_end = zones[k+1];
					var start_date = new Date(+date + zone_start*60*1000);
					var end_date = new Date(+date + zone_end*60*1000);

					start_date = new Date(start_date.valueOf() + (start_date.getTimezoneOffset() - date.getTimezoneOffset())*1000*60);

					end_date = new Date(end_date.valueOf() + (end_date.getTimezoneOffset() - date.getTimezoneOffset())*1000*60);

					if (!(min_date < end_date && max_date > start_date))
						continue;

					var block = scheduler._get_block_by_config(options);
					block.className = css_classes;

					var start_pos = scheduler._timeline_getX({start_date: start_date}, false, view_opts)-1;
					var end_pos = scheduler._timeline_getX({start_date: end_date}, false, view_opts)-1;
					var width = Math.max(1, end_pos - start_pos - 1);
					var height = ((view_opts._section_height[unit_id]-1) || (view_opts.dy - 1));

					block.style.cssText = "height: "+height+"px; " + (scheduler.config.rtl ? "right: " :"left: ")+start_pos+"px; width: "+width+"px; top: 0;";

					area.insertBefore(block, area.firstChild);
					blocks.push(block);
				}
			}
		}

		return blocks;

	} else {
			return old_render_marked_timespan.apply(scheduler, [options, area, unit_id]);
	}
};

var old_append_mark_now = scheduler._append_mark_now;
scheduler._append_mark_now = function(day_index, now) {
	if (scheduler.matrix && scheduler.matrix[scheduler._mode]) {
		var n_date = scheduler._currentDate();
		var zone_start = scheduler._get_zone_minutes(n_date);
		var options = {
			days: +scheduler.date.date_part(n_date),
			zones: [zone_start, zone_start+1],
			css: "dhx_matrix_now_time",
			type: "dhx_now_time"
		};
		return scheduler._render_marked_timespan(options);
	} else {
		return old_append_mark_now.apply(scheduler, [day_index, now]);
	}
};

var oldTimespans = scheduler._mark_timespans;
scheduler._mark_timespans = function(){
	if(scheduler.matrix && scheduler.matrix[scheduler.getState().mode]){
		var divs = [];

		var view = scheduler.matrix[scheduler.getState().mode];
		var options = view.y_unit;
		for(var i = 0; i < options.length; i++){
			var unit_key = options[i].key;
			var scale = view._scales[unit_key];

			var r = scheduler._on_scale_add_marker(scale, unit_key);
			divs.push.apply(divs, r);
		}

		return divs;
	}else{
		return oldTimespans.apply(this, arguments);
	}
};

var on_scale_marker_add = scheduler._on_scale_add_marker;
scheduler._on_scale_add_marker = function(scale, unit_key){

	if (scheduler.matrix && scheduler.matrix[scheduler._mode]) {
		var divs = [];
		var timespans = scheduler._marked_timespans;

		if (timespans && scheduler.matrix && scheduler.matrix[scheduler._mode]) {
			var mode = scheduler._mode;

			var min_date = scheduler._min_date;
			var max_date = scheduler._max_date;
			var global_data = timespans["global"];

			for (var t_date = scheduler.date.date_part(new Date(min_date)); t_date < max_date; t_date = scheduler.date.add(t_date, 1, "day")) {
				var day_value = +t_date;
				var day_index = t_date.getDay();
				var r_configs = [];

				var day_types = global_data[day_value]||global_data[day_index];
				r_configs.push.apply(r_configs, scheduler._get_configs_to_render(day_types));

				if (timespans[mode] && timespans[mode][unit_key]) {
					var z_config = [];
					var unit_types = scheduler._get_types_to_render(timespans[mode][unit_key][day_index], timespans[mode][unit_key][day_value]);
					z_config.push.apply(z_config, scheduler._get_configs_to_render(unit_types));
					if(z_config.length)
						r_configs = z_config;
				}

				for (var i=0; i<r_configs.length; i++) {
					var config = r_configs[i];
					var day = config.days;
					if (day < 7) {
						day = day_value;
						//specify min/max timespan dates, otherwise it can be rendered multiple times in some configurations
						divs.push.apply(divs, scheduler._render_marked_timespan(config, scale, unit_key, t_date, scheduler.date.add(t_date, 1, "day")));
						day = day_index;
					} else {
						divs.push.apply(divs, scheduler._render_marked_timespan(config, scale, unit_key, t_date, scheduler.date.add(t_date, 1, "day")));
					}
				}
			}
		}
		return divs;
	}else{
		return on_scale_marker_add.apply(this, arguments);
	}
};

scheduler._resolve_timeline_section = function(view, pos){
	var yind = 0;
	var summ = 0;
	for (yind; yind < this._colsS.heights.length; yind++) {
		summ += this._colsS.heights[yind];
		if (summ > pos.y)
			break;
	}

	if(!view.y_unit[yind]) {
		yind=view.y_unit.length-1;
	}
	if(this._drag_event && !this._drag_event._orig_section){
		this._drag_event._orig_section = view.y_unit[yind].key;
	}

	pos.fields = {};
	if (yind >= 0 && view.y_unit[yind]) {
		pos.section = pos.fields[view.y_property] = view.y_unit[yind].key;
	}
};
scheduler._update_timeline_section = function(action){
	var view = action.view,
		event = action.event,
		pos = action.pos;

	if (event) {
		if(event[view.y_property] != pos.section){
			var line_height = this._get_timeline_event_height(event, view);
			event._sorder = this._get_dnd_order(event._sorder, line_height, view._section_height[pos.section]);
		}
		event[view.y_property] = pos.section;
	}
};
scheduler._get_date_index=function(config, date) {
	var trace_x = config._trace_x;

	var searchFrom = 0,
		searchTo = trace_x.length - 1;

	// reduce search range with binary search
	var dateValue = date.valueOf();
	while(searchTo - searchFrom > 3){
		var middle = searchFrom + Math.floor((searchTo - searchFrom)/2);
		if(trace_x[middle].valueOf() > dateValue){
			searchTo = middle;
		}else{
			searchFrom = middle;
		}
	}

	var index = searchFrom;
	while (index <= searchTo && +date >= +trace_x[index+1]) {
		index++;
	}
	return index;
};

scheduler._timeline_drag_date = function(timeline, pos_x){
	var obj = timeline,
		pos = {x: pos_x};

	if(!obj._trace_x.length){
		return new Date(scheduler.getState().date);
	}

	var summ = 0, xind = 0;
	var ratio,
		column_width;
	for (xind; xind <= this._cols.length-1; xind++) {

		column_width = this._cols[xind];
		summ += column_width;
		if (summ>pos.x){ //index of section
			ratio = (pos.x-(summ-column_width))/column_width;
			ratio = (ratio < 0) ? 0 : ratio;
			break;
		}
	}

	if(obj.round_position){
		// in case of click, or creating new event, mouse position will be always rounded to start date of the cell
		// when dragging - position can be rounded to the start date of the next column, in order to improve the usability
		// edge = 1 - always return start date of current cell
		// 0.5 - round to next cell if mouse in the right half of cell
		var edge = 1;
		var mode = scheduler.getState().drag_mode;
		if(mode && mode != "move" && mode != "create"){
			edge = 0.5;//rounding for resize
		}
		if(ratio >= edge){
			xind++;
		}
		ratio = 0;
	}

	//border cases
	if (xind === 0 && this._ignores[0]) {
		xind = 1; ratio = 0;
		while (this._ignores[xind]) xind++;
	} else if ( xind == this._cols.length && this._ignores[xind-1]) {
		xind = this._cols.length-1; ratio = 0;
		while (this._ignores[xind]) xind--;
		xind++;
	}

	var end_date;
	// if our event is at the end of the view
	if(xind >= obj._trace_x.length) {
		end_date = scheduler.date.add(obj._trace_x[obj._trace_x.length-1], obj.x_step, obj.x_unit);
		if (obj._end_correction)
			end_date = new Date(end_date-obj._end_correction);
	} else {
		var timestamp_diff = ratio * column_width * obj._step + obj._start_correction;
		end_date = new Date(+obj._trace_x[xind]+timestamp_diff);
	}
	return end_date;
};

scheduler.attachEvent("onBeforeTodayDisplayed", function() {
	for(var i in scheduler.matrix){
		var obj = scheduler.matrix[i];
		obj.x_start = obj._original_x_start;
	}
	return true;
});

scheduler.attachEvent("onOptionsLoad",function(){
	for(var i in scheduler.matrix){
		var obj = scheduler.matrix[i];

		obj.order = {};
		scheduler.callEvent('onOptionsLoadStart', []);
		for(var i=0; i<obj.y_unit.length;i++)
			obj.order[obj.y_unit[i].key]=i;
		scheduler.callEvent('onOptionsLoadFinal', []);
		if (scheduler._date && obj.name == scheduler._mode) {
			obj._options_changed = true;
			scheduler.setCurrentView(scheduler._date, scheduler._mode);
			setTimeout(function () {
				obj._options_changed = false;
			});
		}
	}
});

scheduler.attachEvent("onEventIdChange", function(){
	var view = scheduler.getView();
	if(view && scheduler.matrix[view.name]){
		if(scheduler._timeline_smart_render){

			scheduler._timeline_smart_render.clearPreparedEventsCache();
			scheduler._timeline_smart_render.getPreparedEvents(view);
		}
	}

});

scheduler.attachEvent("onBeforeDrag",function(id, drag_mode, e){
	if(drag_mode == 'resize'){
		var trg = e.target || e.srcElement;
		var className = scheduler._getClassName(trg);
		if(className.indexOf("dhx_event_resize_end") < 0){
			scheduler._drag_from_start = true;
		}else{
			scheduler._drag_from_start = false;
		}
	}

	return true;
});

/* autoscroll start */

var scrollInterval = 10;

var interval = null,
	startPos = null;

function getRelativeCoordinates (e, parent) {
	var view = scheduler.matrix[scheduler._mode];
	var pos = {},
		offset = {},
		container = parent;

	pos.x = !!e.touches ? e.touches[ 0 ].pageX : e.pageX;
	pos.y = !! e.touches ? e.touches[ 0 ].pageY : e.pageY;

	offset.left = container.offsetLeft + view.dx;
	offset.top = container.offsetTop;

	while ( container ) {

		offset.left += container.offsetLeft;
		offset.top += container.offsetTop;

		container = container.offsetParent;
	}

	return {
		x : pos.x - offset.left,
		y : pos.y - offset.top
	};
}

function autoscrollInterval(event){
	if(interval)
		clearInterval(interval);

	scheduler._schedulerOuter =  scheduler.$container.querySelector(".dhx_timeline_data_wrapper");

	var eventPos = {
		pageX: !!event.touches ? event.touches[0].pageX : event.pageX,
		pageY: !!event.touches ? event.touches[0].pageY : event.pageY
	};
	interval = setInterval(function(){tick(eventPos);}, scrollInterval);
}

function tick(e){
	if(!scheduler.getState().drag_id) {
		clearInterval(interval);
		startPos = null;
		return;
	}

	var view = scheduler.matrix[scheduler._mode];
	if(!view)
		return;

	var viewport = scheduler._schedulerOuter;
	var box = getRelativeCoordinates(e, viewport);

	var availWidth = viewport.offsetWidth - view.dx;
	var availHeight = viewport.offsetHeight;

	var posX = box.x;
	var posY = box.y;

	var settings = view.autoscroll || {};

	scheduler._merge(settings, {
		range_x: 200,// px to edge
		range_y: 100,
		speed_x: 20,// speed
		speed_y: 10
	});

	var scrollLeft = need_scroll(posX, availWidth, startPos ? startPos.x : 0, settings.range_x);
	if(!view.scrollable){
		scrollLeft = 0;
	}
	var scrollTop = need_scroll(posY, availHeight, startPos ? startPos.y : 0, settings.range_y);

	if((scrollTop || scrollLeft) && !startPos){
		startPos = {
			x: posX,
			y: posY
		};

		scrollLeft = 0;
		scrollTop = 0;
	}

	scrollLeft = scrollLeft * settings.speed_x;
	scrollTop = scrollTop * settings.speed_y;

	if(scrollLeft && scrollTop){
		if(Math.abs(scrollLeft / 5) > Math.abs(scrollTop)){
			scrollTop = 0;
		}else if(Math.abs(scrollTop / 5) > Math.abs(scrollLeft)){
			scrollLeft = 0;
		}
	}

	if(scrollLeft || scrollTop){
		startPos.started = true;
		scroll(scrollLeft, scrollTop);
	}else{
		clearInterval(interval);
	}
}

function need_scroll(pos, boxSize, startCoord, scrollRange){
	if(pos < scrollRange && (!startPos || startPos.started || pos < startCoord)){
		return -1;
	}else if(boxSize - pos < scrollRange && (!startPos || startPos.started || pos > startCoord)){
		return 1;
	}
	return 0;
}

function scroll(left, top){
	var viewport = scheduler._schedulerOuter;
	if(top){
		viewport.scrollTop += top;
	}
	if (left){ // + 40 - adjust height of that movement was correct
		viewport.scrollLeft += left;
	}
}


var evId = scheduler.attachEvent("onSchedulerReady", function(){
	if (scheduler.matrix) {
		scheduler.event(document.body, "mousemove", autoscrollInterval);
		scheduler.detachEvent(evId);
	}
});

/* autoscroll end */
/* timeline smart render */

// scrollable should be = true
// horizontal and vertical scroll -> dhx_timeline_scrollable_data

scheduler._timeline_smart_render = {
	_prepared_events_cache: null,
	_rendered_events_cache: [],
	_rendered_header_cache: [],
	_rendered_labels_cache: [],
	_rows_to_delete: [],
	_rows_to_add: [],
	_cols_to_delete: [],
	_cols_to_add: [],

	getViewPort: function(scrollHelper, resizeHeight, scrollLeft, scrollTop){
		// top/left/height/width of viewport with scroll pos
		var scrollBlock = scheduler.$container.querySelector(".dhx_cal_data");
		var coords = scrollBlock.getBoundingClientRect();

		var scrollableContainer = scheduler.$container.querySelector(".dhx_timeline_scrollable_data");
		if(scrollableContainer && scrollLeft === undefined){
			scrollLeft = scrollHelper.getScrollValue(scrollableContainer);
		}
		if(scrollTop === undefined){
			if(scrollableContainer){
				scrollTop = scrollableContainer.scrollTop;
			}else{
				scrollTop = scrollBlock.scrollTop;
			}
		}

		var copy = {};
		for(var i in coords){
			copy[i] = coords[i];
		}

		copy.scrollLeft = scrollLeft || 0;
		copy.scrollTop = scrollTop || 0;
		if (resizeHeight)
			coords.height = resizeHeight;

		return copy;
	},
	isInXViewPort: function (item, viewPort) {
		var viewPortLeft =  viewPort.scrollLeft;
		var viewPortRight = viewPort.width + viewPort.scrollLeft;

		// return true/false for item in/not in viewport on X axis
		return (item.left < viewPortRight + 100 && item.right > viewPortLeft - 100); // +100 and -100 spreads viewport width
	},
	isInYViewPort: function (item, viewPort) {
		var viewPortTop =  viewPort.scrollTop;
		var viewPortBottom = viewPort.height + viewPort.scrollTop;

		// return true/false for item in/not in viewport on Y axis
		return (item.top < (viewPortBottom + 100) && item.bottom > viewPortTop - 100); // +100 and -100 spreads viewport height
	},

	getVisibleHeader: function(view, viewPort) {
		var curHeader = '';
		this._rendered_header_cache = [];

		for (var i in view._h_cols) {
			var col = view._h_cols[i];
			if (this.isInXViewPort({left: col.left, right: col.left + scheduler._cols[i]}, viewPort)) {
				var html = col.div.outerHTML;
				curHeader += html;

				this._rendered_header_cache.push(col.div.getAttribute("data-col-id"));
			}
		}

		return curHeader;
	},

	updateHeader: function(view, viewPort, parent) {
		this._cols_to_delete = [];
		this._cols_to_add = [];

		var headers = scheduler.$container.querySelectorAll(".dhx_cal_header > div");
		var cells = headers[headers.length - 1].querySelectorAll(".dhx_scale_bar");// take cells of bottom scale

		var visibleItems = [];
		for(var i = 0; i < cells.length; i++){
			visibleItems.push(cells[i].getAttribute("data-col-id"));
		}

		// find new elements
		var res = this.getVisibleHeader(view, viewPort);
		if (!res)
			return;

		var renderers = this._rendered_header_cache.slice();
		var itemsToDel = [];

		for (var i = 0, len = visibleItems.length; i < len; i++) {
			var pos = renderers.indexOf(visibleItems[i]);
			if ( pos > -1) {
				renderers.splice(pos, 1);
			} else {
				itemsToDel.push(visibleItems[i]);
			}
		}

		if (itemsToDel.length) {
			this._cols_to_delete = itemsToDel.slice();
			this._deleteHeaderCells(itemsToDel, view, parent);
		}
		if (renderers.length)  {
			this._cols_to_add = renderers.slice();
			this._addHeaderCells(renderers, view, parent);
		}
	},

	_deleteHeaderCells: function(items, view, parent) {
		for (var i = 0; i < items.length; i++) {
			var item = parent.querySelector('[data-col-id="'+items[i]+'"]');
			if(item){
				parent.removeChild(item);
			}
		}
	},

	_addHeaderCells: function(items, view, parent) {
		var html = '';
		for (var i = 0; i < items.length; i++) {
			html += view._h_cols[items[i]].div.outerHTML;
		}

		parent.insertAdjacentHTML('beforeEnd', html);
	},

	getVisibleLabels: function(view, viewPort) {
		if (!view._label_rows.length) return;

		var curLabelCol = '';

		this._rendered_labels_cache = [];
		for (var i = 0; i < view._label_rows.length; i++) {
			if (this.isInYViewPort({top: view._label_rows[i].top, bottom: view._label_rows[i].top + view._section_height[view.y_unit[i].key]}, viewPort)) {
				var html = view._label_rows[i].div;
				curLabelCol += html;

				this._rendered_labels_cache.push(i);
			}
		}

		return curLabelCol;
	},

	updateLabels: function(view, viewPort, parent) {
		this._rows_to_delete = [];
		this._rows_to_add = [];

		var visibleItems = this._rendered_labels_cache.slice();

		// is it realy no visible items? check it again
		if (!visibleItems.length) {
			this.getVisibleLabels(view, viewPort);
			visibleItems = this._rendered_labels_cache.slice();
		}

		// find new elements
		var res = this.getVisibleLabels(view, viewPort);
		if (!res)
			return;

		var renderers = this._rendered_labels_cache.slice();

		var itemsToDel = [];

		for (var i = 0, len = visibleItems.length; i < len; i++) {
			var pos = renderers.indexOf(visibleItems[i]);
			if ( pos > -1) {
				renderers.splice(pos, 1);
			} else {
				itemsToDel.push(visibleItems[i]);
			}
		}

		if (itemsToDel.length) {
			this._rows_to_delete = itemsToDel.slice();
			this._deleteLabelCells(itemsToDel, view, parent);
		}
		if (renderers.length) {
			this._rows_to_add = renderers.slice();
			this._addLabelCells(renderers, view, parent);
		}
	},

	_deleteLabelCells: function(items, view, parent) {
		for (var i = 0; i < items.length; i++) {
			var item = parent.querySelector('[data-row-index="'+items[i]+'"]');
			if(item){
				parent.removeChild(item);
			}
		}
	},

	_addLabelCells: function(items, view, parent) {
		var html = '';
		for (var i = 0; i < items.length; i++) {
			html += view._label_rows[items[i]].div;
		}

		parent.insertAdjacentHTML('beforeEnd', html);
	},

	clearPreparedEventsCache: function () {
		this.cachePreparedEvents(null);
	},
	cachePreparedEvents: function(events){
		this._prepared_events_cache = events;
		this._prepared_events_coordinate_cache = events;

	},

	getPreparedEvents: function(view){
		var evs;
		if(this._prepared_events_cache){
			evs = this._prepared_events_cache;
		}else{
			evs = scheduler._prepare_timeline_events(view);
			evs.$coordinates = {};
			this.cachePreparedEvents(evs);




			//var x_start = scheduler._timeline_getX(evs[i][m], false, view);
			//		var x_end = scheduler._timeline_getX(evs[i][m], true, view);
		}
		return evs;
	},

	updateEvents: function(view, viewPort) {
		var evs = this.getPreparedEvents(view);

		var visibleEvents = this._rendered_events_cache.slice();
		this._rendered_events_cache = [];

		var grid = scheduler.$container.querySelector('.dhx_cal_data .dhx_timeline_data_col');
		if (!grid) return;

		for (var i = 0; i < this._rendered_labels_cache.length; i++) {
			var row = this._rendered_labels_cache[i];
			var eventsToAdd = [];

			var visibleRowEvents = visibleEvents[row] ? visibleEvents[row].slice() : [];
			scheduler._timeline_calculate_event_positions.call(view, evs[row]);
			var renderers = scheduler._timeline_smart_render.getVisibleEventsForRow(view, viewPort, evs, row);

			for (var item = 0, lenRend = renderers.length; item < lenRend; item++) {
				var pos = visibleRowEvents.indexOf(renderers[item].id);
				if ( pos > -1) {
					visibleRowEvents.splice(pos, 1);
				} else {
					eventsToAdd.push(renderers[item]);
				}
			}

			var line = grid.querySelector('[data-section-index="'+ row +'"]');

			if (visibleRowEvents.length) {
				this._deleteEvents(visibleRowEvents, view, line);
			}
			if (eventsToAdd.length) {
				this._addEvents(eventsToAdd, view, line, row);
			}
		}
		scheduler._populate_timeline_rendered(scheduler.$container);
		view._matrix = evs;
	},

	_deleteEvents: function(events, view, parent) {
		for (var i = 0; i < events.length; i++) {
			var event = parent.querySelector('[event_id="'+ events[i] +'"]');
			if (event) {
				if (!event.classList.contains('dhx_in_move'))
					parent.removeChild(event);
			}
		}
	},

	_addEvents: function(events, view, parent, i) {
		// calculate height of all events but will render below only events in viewport
		var events_html = scheduler._timeline_update_events_html.call(view, events);
		parent.insertAdjacentHTML('beforeEnd', events_html);
	},

	getVisibleEventsForRow: function(view, viewPort, evs, rowIndex) {
		// get events only for viewport
		var evsInViewport = [];
		if (view.render == "cell") {
			evsInViewport = evs;
		} else {
			var rowEvents = evs[rowIndex];
			if (rowEvents) {
				for (var m = 0, evLen = rowEvents.length; m < evLen; m++) {
					var event = rowEvents[m];
					var coordinateCacheKey = rowIndex + '_' + event.id;
					var xStart, xEnd;
					if (evs.$coordinates && evs.$coordinates[coordinateCacheKey]) {
						xStart = evs.$coordinates[coordinateCacheKey].xStart;
						xEnd = evs.$coordinates[coordinateCacheKey].xEnd;
					} else {
						xStart = scheduler._timeline_getX(event, false, view);
						xEnd = scheduler._timeline_getX(event, true, view);

						if (evs.$coordinates) {
							evs.$coordinates[coordinateCacheKey] = {
								xStart: xStart,
								xEnd: xEnd
							};
						}
					}

					if (scheduler._timeline_smart_render.isInXViewPort({left: xStart, right: xEnd}, viewPort)) {
						evsInViewport.push(event);

						// save to cache
						if (!this._rendered_events_cache[rowIndex])
							this._rendered_events_cache[rowIndex] = [];
						this._rendered_events_cache[rowIndex].push(event.id);
					}
				}
			}
		}

		return evsInViewport;
	},

	getVisibleRowCellsHTML: function(view, viewPort, stats, evs, i) {
		// full render for new row uses _rendered_header_cache
		// that contains currently visible cols
		var dataWrapper = '';
		var cellLeftPos;

		var visibleColumns = this._rendered_header_cache;

		for (var ind = 0; ind < visibleColumns.length; ind++) {
			var j = visibleColumns[ind];

			cellLeftPos = view._h_cols[j].left - view.dx;

			if (scheduler._ignores[j]){

				if (view.render == "cell"){
					dataWrapper += scheduler._timeline_get_html_for_cell_ignores(stats);
				}else{
					dataWrapper += scheduler._timeline_get_html_for_bar_ignores();
				}
			}else {
				if (view.render == "cell"){
					dataWrapper += scheduler._timeline_get_html_for_cell(j, i, view, evs[i][j], stats, cellLeftPos);
				}else{
					dataWrapper += scheduler._timeline_get_html_for_bar(j, i, view, evs[i], cellLeftPos);
				}
			}
		}

		return dataWrapper;
	},

	getVisibleTimelineRowsHTML: function(view, viewPort, evs, rowIndex) {
		var dataWrapper = '';
		var stats = scheduler._timeline_get_cur_row_stats(view, rowIndex);
		stats = scheduler._timeline_get_fit_events_stats(view, rowIndex, stats);

		var cachedRow = view._label_rows[rowIndex];

		var template = scheduler.templates[view.name + "_row_class"];
		var templateParams = { view: view, section: cachedRow.section, template: template};
		// check vertical direction
		if (view.render == "cell") {
			dataWrapper += scheduler._timeline_get_html_for_cell_data_row(rowIndex, stats, cachedRow.top, cachedRow.section.key, templateParams);
			dataWrapper += this.getVisibleRowCellsHTML(view, viewPort, stats, evs, rowIndex);
			dataWrapper += '</div>';
		} else {
			//section 2
			dataWrapper += scheduler._timeline_get_html_for_bar_matrix_line(rowIndex, stats, cachedRow.top, cachedRow.section.key, templateParams);

			// section 3
			dataWrapper += scheduler._timeline_get_html_for_bar_data_row(stats, templateParams);
			dataWrapper += this.getVisibleRowCellsHTML(view, viewPort, stats, evs, rowIndex);
			dataWrapper += "</div></div>";
		}

		return dataWrapper;
	},

	updateGridRows: function(view, viewPort) {
		if (this._rows_to_delete.length) {
			this._deleteGridRows(this._rows_to_delete);
		}
		if (this._rows_to_add.length) {
			this._addGridRows(this._rows_to_add, view, viewPort);
		}
	},

	_deleteGridRows: function(items) {
		var parent = scheduler.$container.querySelector('.dhx_cal_data .dhx_timeline_data_col');
		if (!parent) return;

		for (var i = 0; i < items.length; i++) {
			var item = parent.querySelector('[data-section-index="'+(items[i])+'"]');
			parent.removeChild(item);
		}

		this._rows_to_delete = [];
	},

	_addGridRows: function(items, view, viewPort) {
		var parent = scheduler.$container.querySelector('.dhx_cal_data .dhx_timeline_data_col');
		if (!parent) return;

		var evs = this.getPreparedEvents(view);

		var html = '';
		var addedRows = [];
		for (var i = 0; i < items.length; i++) {
			html += this.getVisibleTimelineRowsHTML(view, viewPort, evs, items[i]);

		}

		parent.insertAdjacentHTML('beforeEnd', html);

		for (var i = 0; i < items.length; i++) {
			scheduler._timeline_finalize_section_add(view, view.y_unit[items[i]].key, parent);
		}
		if (scheduler._mark_now) {
			scheduler._mark_now();
		}
		this._rows_to_add = [];
	},

	updateGridCols: function(view, viewPort) {
		var visibleHeaderColumns = this._rendered_header_cache;

		var renderedTimelineColumnsHash = {};
		var visibleHeaderColumnsHash = {};
		for(var i = 0; i < visibleHeaderColumns.length; i++){
			visibleHeaderColumnsHash[visibleHeaderColumns[i]] = true;
		}

		var anyRow = scheduler.$container.querySelector(".dhx_timeline_data_row");
		if(anyRow){
			var columns = anyRow.querySelectorAll("[data-col-id]");
			for(var i = 0; i < columns.length; i++){
				renderedTimelineColumnsHash[columns[i].getAttribute("data-col-id")] = true;
			}
		}

		var shouldDelete = [],
			shouldRender = [];

		for(var i in renderedTimelineColumnsHash){
			if(!visibleHeaderColumnsHash[i]){
				shouldDelete.push(i);
			}
		}
		for(var i in visibleHeaderColumnsHash){
			if(!renderedTimelineColumnsHash[i]){
				shouldRender.push(i);
			}
		}

		if (shouldDelete.length) {
			this._deleteGridCols(shouldDelete, view);
		}
		if (shouldRender.length) {
			this._addGridCols(shouldRender, view, viewPort);
		}
	},

	_deleteGridCols: function(items, view) {
		var grid = scheduler.$container.querySelector('.dhx_cal_data .dhx_timeline_data_col');
		if (!grid) return;

		for (var r = 0; r < this._rendered_labels_cache.length; r++) {
			var parent;

			if (view.render == 'cell') {
				parent = grid.querySelector('[data-section-index="'+(this._rendered_labels_cache[r])+'"]');
			} else {
				parent = grid.querySelector('[data-section-index="'+(this._rendered_labels_cache[r])+'"] .dhx_timeline_data_row ');
			}

			if (parent) {
				for (var i = 0; i < items.length; i++) {
					var item = parent.querySelector('[data-col-id="'+items[i]+'"]');
					if (item)
						parent.removeChild(item);
				}
			}
		}

		this._cols_to_delete = [];
	},

	_addGridCols: function(items, view, viewPort) {
		var grid = scheduler.$container.querySelector('.dhx_cal_data .dhx_timeline_data_col');
		if (!grid) return;

		var evs = this.getPreparedEvents(view);

		for (var r = 0; r < this._rendered_labels_cache.length; r++) {
			var i = this._rendered_labels_cache[r];
			var html = '';
			var stats = scheduler._timeline_get_cur_row_stats(view, i);
			stats = scheduler._timeline_get_fit_events_stats(view, i, stats);

			var parent;

			if (view.render == 'cell') {
				parent = grid.querySelector('[data-section-index="'+ i +'"]');
			} else {
				parent = grid.querySelector('[data-section-index="'+ i +'"] .dhx_timeline_data_row');
			}

			if (parent) {
				for (var j = 0; j < items.length; j++) {
					var item = parent.querySelector('[data-col-id="'+items[j]+'"]');

					if (!item) {
						var cell = this.getVisibleGridCell(view, viewPort, stats, evs, i, items[j]);
						if (cell)
							html += cell;
					}
				}

				parent.insertAdjacentHTML('beforeEnd', html);
			}
		}

		this._cols_to_add = [];
	},

	getVisibleGridCell: function(view, viewPort, stats, evs, i, cellIndex) {
		if (!view._h_cols[cellIndex]) return;
		var dataWrapper = '';
		var cellLeftPos = view._h_cols[cellIndex].left-view.dx;

		if (view.render == "cell") {
			if (scheduler._ignores[cellIndex]){
				//dataWrapper += scheduler._timeline_get_html_for_cell_ignores(stats);
			}else {
				dataWrapper += scheduler._timeline_get_html_for_cell(cellIndex, i, view, evs[i][cellIndex], stats, cellLeftPos);
			}
		} else {
			if (scheduler._ignores[cellIndex]){
				//dataWrapper += scheduler._timeline_get_html_for_bar_ignores();
			}else {
				dataWrapper += scheduler._timeline_get_html_for_bar(cellIndex, i, view, evs[i], cellLeftPos);
			}
		}

		return dataWrapper;
	}
};

/* timeline smart render end */


};
scheduler._temp_matrix_scope();


});
